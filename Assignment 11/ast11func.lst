     1                                 %line 1+1 ast11func.asm
     2                                 
     3                                 
     4                                 
     5                                 
     6                                 
     7                                 
     8                                 
     9                                 
    10                                 [section .data]
    11                                 
    12                                 
    13                                 
    14                                 
    15                                 TRUE equ 1
    16                                 FALSE equ 0
    17                                 
    18                                 SUCCESS equ 0
    19                                 NOSUCCESS equ 1
    20                                 
    21                                 STDIN equ 0
    22                                 STDOUT equ 1
    23                                 STDERR equ 2
    24                                 
    25                                 SYS_read equ 0
    26                                 SYS_write equ 1
    27                                 SYS_open equ 2
    28                                 SYS_close equ 3
    29                                 SYS_lseek equ 8
    30                                 SYS_fork equ 57
    31                                 SYS_exit equ 60
    32                                 SYS_creat equ 85
    33                                 SYS_time equ 201
    34                                 
    35                                 LF equ 10
    36                                 SPACE equ " "
    37                                 NULL equ 0
    38                                 ESC equ 27
    39                                 
    40                                 O_CREAT equ 0x40
    41                                 O_TRUNC equ 0x200
    42                                 O_APPEND equ 0x400
    43                                 
    44                                 O_RDONLY equ 000000
    45                                 O_WRONLY equ 000001
    46                                 O_RDWR equ 000002
    47                                 
    48                                 S_IRUSR equ 00400
    49                                 S_IWUSR equ 00200
    50                                 S_IXUSR equ 00100
    51                                 
    52                                 
    53                                 
    54                                 
    55                                 KEY_MAX equ 56
    56                                 KEY_MIN equ 16
    57                                 
    58                                 BUFF_SIZE equ 800000
    59                                 
    60                                 
    61                                 
    62                                 
    63 00000000 00                     eof db FALSE
    64                                 
    65 00000001 55736167653A20626C-    usageMsg db "Usage: blowfish <-en|-de> -if <inputFile> "
    66 00000001 6F7766697368203C2D-
    67 00000001 656E7C2D64653E202D-
    68 00000001 6966203C696E707574-
    69 00000001 46696C653E20       
    70 0000002B 2D6F66203C6F757470-     db "-of <outputFile>", LF, NULL
    71 0000002B 757446696C653E0A00 
    72 0000003D 4572726F722C20636F-    errIncomplete db "Error, command line arguments incomplete."
    73 0000003D 6D6D616E64206C696E-
    74 0000003D 6520617267756D656E-
    75 0000003D 747320696E636F6D70-
    76 0000003D 6C6574652E         
    77 00000066 0A00                    db LF, NULL
    78 00000068 4572726F722C20746F-    errExtra db "Error, too many command line arguments."
    79 00000068 6F206D616E7920636F-
    80 00000068 6D6D616E64206C696E-
    81 00000068 6520617267756D656E-
    82 00000068 74732E             
    83 0000008F 0A00                    db LF, NULL
    84 00000091 4572726F722C20656E-    errFlag db "Error, encryption/decryption flag not "
    85 00000091 6372797074696F6E2F-
    86 00000091 64656372797074696F-
    87 00000091 6E20666C6167206E6F-
    88 00000091 7420               
    89 000000B7 76616C69642E0A00        db "valid.", LF, NULL
    90 000000BF 4572726F722C20696E-    errReadSpec db "Error, invalid read file specifier.", LF, NULL
    91 000000BF 76616C696420726561-
    92 000000BF 642066696C65207370-
    93 000000BF 656369666965722E0A-
    94 000000BF 00                 
    95 000000E4 4572726F722C20696E-    errWriteSpec db "Error, invalid write file specifier.", LF, NULL
    96 000000E4 76616C696420777269-
    97 000000E4 74652066696C652073-
    98 000000E4 70656369666965722E-
    99 000000E4 0A00               
   100 0000010A 4572726F722C206F70-    errReadFile db "Error, opening input file.", LF, NULL
   101 0000010A 656E696E6720696E70-
   102 0000010A 75742066696C652E0A-
   103 0000010A 00                 
   104 00000126 4572726F722C206F70-    errWriteFile db "Error, opening output file.", LF, NULL
   105 00000126 656E696E67206F7574-
   106 00000126 7075742066696C652E-
   107 00000126 0A00               
   108                                 
   109                                 
   110                                 
   111                                 
   112 00000143 00350C0000000000       buffMax dq BUFF_SIZE
   113 0000014B 00350C0000000000       curr dq BUFF_SIZE
   114 00000153 00                     wasEOF db FALSE
   115                                 
   116 00000154 4572726F722C207265-    errRead db "Error, reading from file.", LF,
   117 00000154 6164696E672066726F-
   118 00000154 6D2066696C652E0A   
   119 0000016E 50726F6772616D2074-     db "Program terminated.", LF, NULL
   120 0000016E 65726D696E61746564-
   121 0000016E 2E0A00             
   122                                 
   123                                 
   124                                 
   125                                 
   126 00000183 4572726F722C207772-    errWrite db "Error, writting to file.", LF,
   127 00000183 697474696E6720746F-
   128 00000183 2066696C652E0A     
   129 0000019C 50726F6772616D2074-     db "Program terminated.", LF, NULL
   130 0000019C 65726D696E61746564-
   131 0000019C 2E0A00             
   132                                 
   133                                 
   134                                 
   135                                 
   136 000001B1 00                     chr db 0
   137                                 
   138 000001B2 456E746572204B6579-    keyPrompt db "Enter Key (16-56 characters): ", NULL
   139 000001B2 202831362D35362063-
   140 000001B2 686172616374657273-
   141 000001B2 293A2000           
   142 000001D1 4572726F722C20696E-    keyError db "Error, invalid key size.  Key must be between 16 and "
   143 000001D1 76616C6964206B6579-
   144 000001D1 2073697A652E20204B-
   145 000001D1 6579206D7573742062-
   146 000001D1 65206265747765656E-
   147 000001D1 20313620616E6420   
   148 00000206 353620636861726163-     db "56 characters long.", LF, NULL
   149 00000206 74657273206C6F6E67-
   150 00000206 2E0A00             
   151                                 
   152                                 
   153                                 
   154                                 
   155                                 
   156                                 [section .bss]
   157                                 
   158 00000000 <gap>                  buffer resb BUFF_SIZE
   159                                 
   160                                 
   161                                 
   162                                 
   163                                 [section .text]
   164                                 
   165                                 
   166                                 
   167                                 
   168                                 
   169                                 
   170                                 
   171                                 
   172                                 
   173                                 
   174                                 
   175                                 
   176                                 
   177                                 
   178                                 
   179                                 
   180                                 
   181                                 
   182                                 
   183                                 
   184                                 [global getOptions]
   185                                 getOptions:
   186                                 
   187                                 
   188                                 
   189 00000000 53                      push rbx
   190 00000001 4154                    push r12
   191 00000003 4155                    push r13
   192 00000005 4156                    push r14
   193 00000007 4157                    push r15
   194                                 
   195                                 
   196                                 
   197                                 
   198                                 
   199 00000009 4883FF01                cmp rdi, 1
   200 0000000D 0F849F000000            je Err1
   201                                 
   202                                 
   203 00000013 4883FF06                cmp rdi, 6
   204 00000017 0F8CB2000000            jl Err2
   205                                 
   206                                 
   207 0000001D 4883FF06                cmp rdi, 6
   208 00000021 0F8F56010000            jg Err8
   209                                 
   210                                 
   211 00000027 4989F4                  mov r12, rsi
   212                                 
   213                                 
   214 0000002A 4989D6                  mov r14, rdx
   215                                 
   216                                 
   217 0000002D 4989CD                  mov r13, rcx
   218                                 
   219                                 
   220 00000030 4D89C7                  mov r15, r8
   221                                 
   222                                 
   223                                 
   224                                 
   225                                 
   226                                 
   227                                 
   228                                 
   229 00000033 498B5C2408              mov rbx, qword[r12 + 8]
   230                                 
   231                                 
   232 00000038 813B2D656E00            cmp dword[rbx], 0x006e652d
   233 0000003E 740A                    je EnFound
   234                                 
   235 00000040 813B2D646500            cmp dword[rbx], 0x0065642d
   236 00000046 0F85A0000000            jne Err3
   237                                 
   238                                 
   239                                  EnFound:
   240                                 
   241                                 
   242                                 
   243                                 
   244                                 
   245 0000004C 498B5C2410              mov rbx, qword[r12 + 16]
   246                                 
   247                                 
   248 00000051 813B2D696600            cmp dword [rbx], 0x0066692d
   249 00000057 0F85AC000000            jne Err4
   250                                 
   251                                 
   252                                 
   253                                 
   254                                 
   255 0000005D 48C7C002000000          mov rax, SYS_open
   256 00000064 498B7C2418              mov rdi, qword[r12 + 24]
   257 00000069 48C7C600000000          mov rsi, O_RDONLY
   258 00000070 0F05                    syscall
   259                                 
   260                                 
   261 00000072 4883F800                cmp rax, 0
   262 00000076 0F8CAA000000            jl Err5
   263                                 
   264 0000007C 49894500                mov qword[r13], rax
   265                                 
   266                                 
   267                                 
   268                                 
   269                                 
   270 00000080 498B5C2420              mov rbx, qword[r12 + 32]
   271                                 
   272                                 
   273 00000085 813B2D6F6600            cmp dword[rbx], 0x00666f2d
   274 0000008B 0F85B2000000            jne Err6
   275                                 
   276                                 
   277                                 
   278                                 
   279                                 
   280 00000091 48C7C055000000          mov rax, SYS_creat
   281 00000098 498B7C2428              mov rdi, qword[r12 + 40]
   282 0000009D 48C7C680010000          mov rsi, S_IRUSR | S_IWUSR
   283 000000A4 0F05                    syscall
   284                                 
   285                                 
   286 000000A6 4883F800                cmp rax, 0
   287 000000AA 0F8CB0000000            jl Err7
   288                                 
   289 000000B0 498907                  mov qword[r15], rax
   290                                 
   291                                 
   292 000000B3 E9E3000000              jmp NoErrs
   293                                 
   294                                 
   295                                 
   296                                 
   297                                 
   298                                 
   299                                  Err1:
   300                                 
   301                                 
   302 000000B8 48C7C7[00000000]        mov rdi, usageMsg
   303 000000BF E88C010000              call printString
   304                                 
   305                                 
   306 000000C4 48C7C000000000          mov rax, FALSE
   307                                 
   308                                 
   309 000000CB 415F                    pop r15
   310 000000CD 415E                    pop r14
   311 000000CF 415D                    pop r13
   312 000000D1 415C                    pop r12
   313 000000D3 5B                      pop rbx
   314                                 
   315 000000D4 C3                      ret
   316                                 
   317                                 
   318                                 
   319                                  Err2:
   320                                 
   321                                 
   322 000000D5 48C7C7[00000000]        mov rdi, errIncomplete
   323 000000DC E86F010000              call printString
   324                                 
   325                                 
   326 000000E1 48C7C000000000          mov rax, FALSE
   327                                 
   328                                 
   329 000000E8 415F                    pop r15
   330 000000EA 415E                    pop r14
   331 000000EC 415D                    pop r13
   332 000000EE 415C                    pop r12
   333 000000F0 5B                      pop rbx
   334                                 
   335 000000F1 C3                      ret
   336                                 
   337                                 
   338                                 
   339                                  Err3:
   340                                 
   341                                 
   342 000000F2 48C7C7[00000000]        mov rdi, errFlag
   343 000000F9 E852010000              call printString
   344                                 
   345                                 
   346 000000FE 48C7C000000000          mov rax, FALSE
   347                                 
   348                                 
   349 00000105 415F                    pop r15
   350 00000107 415E                    pop r14
   351 00000109 415D                    pop r13
   352 0000010B 415C                    pop r12
   353 0000010D 5B                      pop rbx
   354                                 
   355 0000010E C3                      ret
   356                                 
   357                                 
   358                                 
   359                                  Err4:
   360                                 
   361                                 
   362 0000010F 48C7C7[00000000]        mov rdi, errReadSpec
   363 00000116 E835010000              call printString
   364                                 
   365                                 
   366 0000011B 48C7C000000000          mov rax, FALSE
   367                                 
   368                                 
   369 00000122 415F                    pop r15
   370 00000124 415E                    pop r14
   371 00000126 415D                    pop r13
   372 00000128 415C                    pop r12
   373 0000012A 5B                      pop rbx
   374                                 
   375 0000012B C3                      ret
   376                                 
   377                                 
   378                                 
   379                                  Err5:
   380                                 
   381                                 
   382 0000012C 48C7C7[00000000]        mov rdi, errReadFile
   383 00000133 E818010000              call printString
   384                                 
   385                                 
   386 00000138 48C7C000000000          mov rax, FALSE
   387                                 
   388                                 
   389 0000013F 415F                    pop r15
   390 00000141 415E                    pop r14
   391 00000143 415D                    pop r13
   392 00000145 415C                    pop r12
   393 00000147 5B                      pop rbx
   394                                 
   395 00000148 C3                      ret
   396                                 
   397                                 
   398                                 
   399                                  Err6:
   400                                 
   401                                 
   402 00000149 48C7C7[00000000]        mov rdi, errWriteSpec
   403 00000150 E8FB000000              call printString
   404                                 
   405                                 
   406 00000155 48C7C000000000          mov rax, FALSE
   407                                 
   408                                 
   409 0000015C 415F                    pop r15
   410 0000015E 415E                    pop r14
   411 00000160 415D                    pop r13
   412 00000162 415C                    pop r12
   413 00000164 5B                      pop rbx
   414                                 
   415 00000165 C3                      ret
   416                                 
   417                                 
   418                                 
   419                                  Err7:
   420                                 
   421                                 
   422 00000166 48C7C7[00000000]        mov rdi, errWriteFile
   423 0000016D E8DE000000              call printString
   424                                 
   425                                 
   426 00000172 48C7C000000000          mov rax, FALSE
   427                                 
   428                                 
   429 00000179 415F                    pop r15
   430 0000017B 415E                    pop r14
   431 0000017D 415D                    pop r13
   432 0000017F 415C                    pop r12
   433 00000181 5B                      pop rbx
   434                                 
   435 00000182 C3                      ret
   436                                 
   437                                 
   438                                 
   439                                  Err8:
   440                                 
   441                                 
   442 00000183 48C7C7[00000000]        mov rdi, errExtra
   443 0000018A E8C1000000              call printString
   444                                 
   445                                 
   446 0000018F 48C7C000000000          mov rax, FALSE
   447                                 
   448                                 
   449 00000196 415F                    pop r15
   450 00000198 415E                    pop r14
   451 0000019A 415D                    pop r13
   452 0000019C 415C                    pop r12
   453 0000019E 5B                      pop rbx
   454                                 
   455 0000019F C3                      ret
   456                                 
   457                                 
   458                                 
   459                                 NoErrs:
   460                                 
   461                                 
   462 000001A0 415F                    pop r15
   463 000001A2 415E                    pop r14
   464 000001A4 415D                    pop r13
   465 000001A6 415C                    pop r12
   466 000001A8 5B                      pop rbx
   467                                 
   468 000001A9 48C7C001000000         mov rax, TRUE
   469                                 
   470 000001B0 C3                     ret
   471                                 
   472                                 
   473                                 
   474                                 
   475                                 
   476                                 
   477                                 
   478                                 
   479                                 
   480                                 
   481                                 
   482                                 
   483                                 
   484                                 
   485                                 
   486                                 
   487                                 
   488                                 
   489                                 
   490                                 
   491                                 
   492                                 
   493                                 
   494                                 [global getX]
   495                                 getX:
   496                                 
   497                                 
   498                                 
   499 000001B1 C3                     ret
   500                                 
   501                                 
   502                                 
   503                                 
   504                                 
   505                                 
   506                                 
   507                                 
   508                                 
   509                                 
   510                                 
   511                                 
   512                                 
   513                                 
   514                                 
   515                                 
   516                                 
   517                                 
   518                                 
   519                                 
   520                                 
   521                                 
   522                                 [global writeX]
   523                                 writeX:
   524                                 
   525 000001B2 C3                     ret
   526                                 
   527                                 
   528                                 
   529                                 
   530                                 
   531                                 
   532                                 
   533                                 
   534                                 
   535                                 
   536                                 
   537                                 
   538                                 
   539                                 
   540                                 
   541                                 
   542                                 [global readKey]
   543                                 readKey:
   544                                 
   545                                 
   546                                 
   547 000001B3 55                      push rbp
   548 000001B4 4889E5                  mov rbp, rsp
   549 000001B7 4883EC3A                sub rsp, 58
   550                                 
   551                                 
   552                                 
   553 000001BB 53                      push rbx
   554 000001BC 4154                    push r12
   555 000001BE 4155                    push r13
   556                                 
   557                                 
   558                                 
   559 000001C0 4889FB                  mov rbx, rdi
   560 000001C3 4989F4                  mov r12, rsi
   561 000001C6 4989D5                  mov r13, rdx
   562                                 
   563                                 
   564                                 
   565 000001C9 48C7C7[00000000]        mov rdi, keyPrompt
   566 000001D0 E87B000000              call printString
   567                                 
   568                                 
   569                                 
   570                                 
   571                                 initializeSDLs:
   572                                 
   573 000001D5 53                      push rbx
   574                                 
   575 000001D6 C645C600                mov byte [rbp - 58], 0
   576 000001DA 488D5DC7                lea rbx, byte [rbp - 57]
   577                                 
   578                                 
   579                                 
   580                                 
   581                                 
   582                                 NxtChrLp:
   583                                 
   584                                 
   585 000001DE FE45C6                  inc byte [rbp - 58]
   586                                 
   587                                 
   588 000001E1 48C7C000000000          mov rax, SYS_read
   589 000001E8 48C7C700000000          mov rdi, STDIN
   590 000001EF 48C7C6[00000000]        mov rsi, chr
   591 000001F6 48C7C201000000          mov rdx, 1
   592 000001FD 0F05                    syscall
   593                                 
   594                                 
   595 000001FF 8A0425[00000000]        mov al, byte[chr]
   596 00000206 3C0A                    cmp al, LF
   597 00000208 740D                    je inputDone
   598                                 
   599                                 
   600 0000020A 8A4DC6                  mov cl, byte [rbp - 58]
   601 0000020D 80F938                  cmp cl, KEY_MAX
   602 00000210 7703                    ja SkipStorage
   603                                 
   604                                 
   605 00000212 8803                    mov byte [rbx], al
   606 00000214 48FFC3                  inc rbx
   607                                 
   608                                 
   609                                  SkipStorage:
   610                                 
   611 00000217 EBC3                   jmp NxtChrLp
   612                                 
   613                                 
   614                                 
   615                                 
   616                                 inputDone:
   617                                 
   618                                 
   619                                 
   620                                 
   621                                 
   622 00000219 C60300                 mov byte [rbx], NULL
   623                                 
   624                                 
   625                                 
   626 0000021C 5B                     pop rbx
   627                                 
   628                                 
   629                                 
   630                                 
   631                                 
   632 0000021D 8A45C6                 mov al, byte [rbp - 58]
   633 00000220 3C38                   cmp al, KEY_MAX
   634 00000222 7704                   ja ErrInvInput
   635                                 
   636                                 
   637 00000224 3C10                   cmp al, KEY_MIN
   638 00000226 7C00                   jl ErrInvInput
   639                                 
   640                                 
   641                                 
   642 00000228 EB18                   jmp ExitErrChk
   643                                 
   644                                 
   645                                 
   646                                 
   647                                 
   648                                 ErrInvInput:
   649                                 
   650                                 
   651 0000022A 48C7C7[00000000]        mov rdi, keyError
   652 00000231 E81A000000              call printString
   653                                 
   654                                 
   655 00000236 48C7C7[00000000]        mov rdi, keyPrompt
   656 0000023D E80E000000              call printString
   657                                 
   658                                 
   659 00000242 EB8F                    jmp initializeSDLs
   660                                 
   661                                 
   662                                 
   663                                 
   664                                 ExitErrChk:
   665                                 
   666                                 
   667                                 
   668                                 
   669 00000244 415D                    pop r13
   670 00000246 415C                    pop r12
   671 00000248 5B                      pop rbx
   672                                 
   673                                 
   674 00000249 48C7C001000000         mov rax, TRUE
   675                                 
   676 00000250 4889EC                 mov rsp, rbp
   677 00000253 5D                     pop rbp
   678                                 
   679 00000254 C3                     ret
   680                                 
   681                                 
   682                                 
   683                                 
   684                                 
   685                                 
   686                                 
   687                                 
   688                                 
   689                                 
   690                                 
   691                                 
   692                                 
   693                                 
   694                                 
   695                                 
   696                                 
   697                                 
   698                                 
   699                                 
   700                                 [global printString]
   701                                 printString:
   702                                 
   703                                 
   704                                 
   705                                 
   706 00000255 48C7C200000000          mov rdx, 0
   707                                 strCountLoop:
   708 0000025C 803C1700                cmp byte [rdi+rdx], NULL
   709 00000260 7403                    je strCountLoopDone
   710 00000262 48FFC2                  inc rdx
   711 00000265 EBF3                    jmp strCountLoop
   712                                 strCountLoopDone:
   713 00000267 4883FA00                cmp rdx, 0
   714 0000026B 7411                    je printStringDone
   715                                 
   716                                 
   717                                 
   718                                 
   719 0000026D 48C7C001000000          mov rax, SYS_write
   720 00000274 4889FE                  mov rsi, rdi
   721 00000277 48C7C701000000          mov rdi, STDOUT
   722                                 
   723 0000027E 0F05                    syscall
   724                                 
   725                                 
   726                                 
   727                                 
   728                                 printStringDone:
   729 00000280 C3                      ret
   730                                 
   731                                 
   732                                 
